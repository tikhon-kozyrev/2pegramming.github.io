---
layout: question
title: "Как визуализировать схему базы данных"
categories: questions
published: true
tags:
  - data_model
  - db
  - erd
---

## Вопрос

<div class="question-text" markdown="1">
  > «Возникла проблема, что нужно визуализировать данные, но не понятно с чего начать. Что в таких случаях делаешь и какие есть инструменты для этого?»
</div>


Так как вопрос без конкретики, выделю два случая:
1. Проект только в голове и хочется понять как связаны данные между собой
2. Проект уже реализован в коде и хочется понять, что из себя представляет схема бд

Поэтому, вместо короткого ответа «используй ERD», поговорим о каждом из вариантов. Но сначала разберемся с data modelling, благодаря которому можно определить нужный вид диаграммы для задачи.

## Data modelling

Может показаться, что взять и начать фигачить SQL схему описывающую данные для проекта может быть разумной идеей. На деле это не так:

- Так как нет структуры данных в голове, можно запутаться и упороться в вечное редактирование. А если данных много и связей еще больше - получится хаос который не влезет в голову;
- Полученную модель данных придется валидировать, причем с бизнесом/доменным экспертом. Не разработчикам будет сложно и валидация может затянуться;
- Когнитивная нагрузка увеличивается: работая с текстом, придется этот текст представить в виде модели в голове и потом обратно, из модели в текст;

{%
    include image.html
    url="/public/images/questions/2024-08-01-data-model/schema-vs-visualisation.jpg"
    description="Слева - схема в dbml, которая представлена в виде диаграммы (справа). Когда разбираешься с новым проектом – мне проще сразу картинкой (моделью) оперировать"
    altdescription="dbml: code and visualisation"
%}

В целом, выглядит надежно, как швейцарские часы. Поэтому придумали процесс, который назвали [data modeling](https://en.wikipedia.org/wiki/Data_model). Data modeling помогает с определением релевантных для системы данных, связью между этими данными и как данные работают вместе, т.е. создать data model для системы. Главное, что стоит вынести из этой идеи – моделирование можно разбить на три «перспективы»:

- [Концептуальная](https://en.wikipedia.org/wiki/Conceptual_schema) говорит о том, какие данные используются системой и как данные связаны между собой. Т.е. тут о том, что необходимо бизнесу без привязки к конкретной реализации хранения данных в конкретной бд
- [Логическая](https://en.wikipedia.org/wiki/Logical_schema) говорит о том, как данные структурируются в приложении. Т.е. берем любой язык описания схемы (будь то SQL, dbml или еще что) и описываем таблицы/колонки/классы/etc.
- [Физическая](https://en.wikipedia.org/wiki/Physical_schema) говорит о том, как данные физически храниться будут. Т.е. берем логическое описание и говорим где данные будут находиться физически и как все будет работать в реальности;

{%
    include image.html
    url="/public/images/questions/2024-08-01-data-model/conceptual-vs-logical-models.jpg"
    description="Сравнение концептуальной (правая) и логической (левая) схем, где пример из самого начала. Возможно, я сделал концептуальную модель не корректно, но задача показать идею, а не сделать корректную модель"
    altdescription="dbml: code and visualisation"
%}

При использовании концептуальной модели данных можно отказаться от «технической» информации и оставить только необходимое для реализации бизнесовой модели. Т.е. можно не запариваться с pk, fk и `created_at` для каждого объекта и не думать о таблицах. Так, в примере выше, указан продукт как «элемент», к которому привязаны отдельные «элементы»: цена, тег и статус. Эта информация необходима для бизнес логики, хотя в реальности, если опуститься на логический уровень – данные оказываются в одной таблице.

Теперь, используя информацию о data modeling, можно вернуться к оригинальному вопросу.

## Случай 1: Проект только в голове и хочется понять как связаны данные между собой

Возможно бизнес с нуля делает систему, либо же нужно разобраться в уже работающей бизнес логике (доменной модели). Для этого придется разбираться с данными: какие элементы, как элементы связаны. Если в этот момент думать о том, где какая таблица будет и что в этой таблице должно находиться – выглядит как доп нагрузка которая усложняет работу. Поэтому для первого случая концептуальное представление предпочтительнее: меньше когнитивная нагрузка, проще работать, можно показать бизнесу не объясняя что это за [вилка](https://www.datensen.com/blog/er-diagram/one-to-many-relationships/).

### Виды нотаций концептуальных моделей

Тут список может быть большой, опишу только то, что сам знаю и видел. Подробно на каждой нотации останавливаться не буду, оставлю это на самостоятельное изучение.

- [Нотация IDEF 1х](https://studme.org/77224/informatika/notatsiya_idef)
- [PlantUml](https://studme.org/77225/informatika/notatsiya_uml), тут используется [class diagram](https://en.wikipedia.org/wiki/Class_diagram), что сомнительно, но для общего развития пусть будет.
- Cтоит упомянуть [Open ModelSphere](http://www.modelsphere.com/org/index.html), это oss инструмент, который помогает с моделированием данных не только концептуально, но и логически/физически
 
Отдельно хочется рассказать еще о двух нотациях:

Первая нотация – [ER model](https://en.wikipedia.org/wiki/Entity–relationship_model) (иногда встречается как [нотация Питера Чена](https://studme.org/77222/informatika/notatsiya_pitera_chena)) и тут важно не путать с ER diagram. Модель создана Питером Ченом в 1976 году для абстрактного описания данных. При этом, модель предоставляет абстракции для концептуального/логического/физического моделирования. Интересный факт: эта одна из нотаций, которые повлияли на UML.

Вторая – [нотация концептуальной модели Мартина Фаулера из книги](https://martinfowler.com/books/ap.html), о которой преступно мало знают.

{%
    include image.html
    url="/public/images/questions/2024-08-01-data-model/martin-fowler-notation.jpg"
    description="Так выглядит нотация используемая Фаулером, она описана прямо на первых страницах книги"
    altdescription="dbml: code and visualisation"
%}

Что выбрать – решайте сами. Расскажу о том, что сам использую и почему редко использую описанные выше модели.

### Что сам использую

[Я использую сильно упрощенную нотацию, состоящую только из квадратов и стрелок](https://tough-roadway-bb5.notion.site/1-1-6adfeb2e07eb4269b5966ffb742d7fad#34413c7cc27b4e1da6ee31177875b93b), которую сам и «придумал». При этом, вместо использования сложных видов стрелок, подписываю вид связи который нужен (`has_one`, `has_many`, `optional_has_one/many`, `many_to_many`). Плюс использую цветовое обозначение для данных, которые используются в разных контекстах.

{%
    include image.html
    url="/public/images/questions/2024-08-01-data-model/data-model-example.jpg"
    description="Пример модели из рабочего проекта. Тут кусок модели, [связанный с работой дантистов](https://vc.ru/fedorandsamat/1103649-kak-my-perezapuskali-medicinskuyu-informacionnuyu-sistemu)"
    altdescription="dbml: code and visualisation"
%}

Такой выбор обусловлен двумя причинами:

- Концептуальную модель приходится валидировать с бизнесом/доменными экспертами. Чем сложнее нотация, тем больше шансов, что человек запутается. Плюс грузить и без этого занятых людей так себе подход.
- Внимательность – не обо мне, поэтому с большим шансом запутаюсь или пропущу стрелку/форму и по итогу получится фигня. Рисковать и проверять себя по 10 раз не хочется.

Если в компании уже есть стандарт, либо хотите использовать распространенный стандарт – лучше забыть эту часть текста и использовать то, что уже принято. Если ничего такого нет, возможно стоит скопировать мое решение, а после, если этого окажется мало, выбрать любую из описанных выше нотаций.

### Советы для моделирования данных (не схемы бд)

- Забудьте о таблицах и реализации в бд. Начните с данных, которые необходимы для работы бизнес модели. Главная причина такого категоричного совета – проще замапить корректную концептуальную модель на реализацию конкретной базы данных, чем упороться с реализацией и потерять важные данные. Это может привести к тому, что решение не будет бизнес задачу решать, а будет подстраиваться под техническое решение, вокруг которого зацепитесь;
- Вытекает из первого совета: в концептуальной модели не нужны данные, которые окажутся в базе данных. Поэтому о `pk`, `fk`, `created_at`, etc можно забыть. Только если это не часть доменной модели;
- Не важно какую нотацию выбрали, модель без легенды – деньги на ветер;
- Валидируете модель с бизнесом/доменным экспертом;
- Между дублированием элементов и уменьшением стрелок – выбирайте дублирование. Так можно снизить когнитивную нагрузку, которая появится из-за стрелочного хаоса. По этой же причине старайтесь избегать пересечения стрелок;

С моделированием разобрались. Давайте поговорим о генерации картинок из схемы бд.

## Случай 2: Проект уже реализован в коде и хочется понять, что из себя представляет схема бд

В данном случае, если нужна концептуальная модель – инструментов не знаю, к сожалению. Поэтому, для проектов с реализованной схемой бд, рисую концептуальные модели «руками».

Но если хватит логической модели, можно найти решение. Из того что знаю – ER diagram (которая, является подмножеством ER model). Существует новомодный dbml, который тоже использовал. Еще стоит упомянуть [Нотацию Мартина (Crow's Foot)](https://studme.org/77223/informatika/notatsiya_martina_crows_foot), но в живую не наблюдал. Если знаете другие варианты – буду рад комментариями, ибо самому интересно, а быстро нагуглить альтернативы не вышло.

Для генерации «картинки» я использую следующие подходы:

### Генерация модели из кода

В эту секцию входят:
- инструменты diagram as a code: [graphiz](https://graphviz.org/Gallery/neato/ER.html), [mermaid](https://mermaid.js.org/syntax/entityRelationshipDiagram.html)
- библиотеки для разных языков ([python](https://github.com/drivendataorg/erdantic), [ruby](https://github.com/voormedia/rails-erd), [elixir/ecto](https://github.com/fuelen/ecto_erd), [golang](https://github.com/gmarik/go-erd), [js/prisma](https://www.npmjs.com/package/prisma-erd-generator), etc) которые под капотом используют graphiz.

С вероятностью в 99% там будет ERD. А подход подойдет в двух случаях:
- Если схема данных меньше ~15 таблиц и хочется быстро подключить генератор, а после забыть и получать каждый релиз новый артефакт;
- Если модель нужна для поста или показать идею;

**Плюсы:**

- Работает для схем, где таблиц меньше ~15 или когда связей мало между таблицами;
- Библиотеки работают из коробки и легко настраиваются;
- Если говорим о библиотеках – нет проблем с обновлением схемы после изменений, так как генерируется новый файл;
- Легко шарить между коллегами. Отправляем картинку в чат, добавляем в репозиторий или конфлюенс/ноушен/etc;


**Из минусов:**

- Нельзя поменять положение элементов или связей. А автоматическая генерация не поддается логике;
- На больших схемах получается не читаемая каша. Особенно, когда дело касается связей;
- Генерируется векторная картинка, если схема увесистая – может шакалить;

### Генерация ERD в инструментах для диаграм

Lucidchart предоставляет [инструмент, который генерирует ERD по загруженной схеме бд](https://www.lucidchart.com/pages/examples/er-diagram-tool). Дальше получаете диаграмму, в которой можно двигать элементы, стрелки, добавлять новые элементы, менять цвета и делать что угодно.

Draw.io реализовали [аналогичный инструмент](https://www.drawio.com/doc/faq/sql-plugin). Только для работы придется вставлять SQL код. После, с полученной схемой, также можно производит манипуляции с диаграммой.

{%
    include image.html
    url="/public/images/questions/2024-08-01-data-model/erd-bad-example.jpg"
    description="Пример сгенерированной ERD в lucidchart. Получи такое картинкой – сразу бы отказался от проекта"
    altdescription="dbml: code and visualisation"
%}

**Плюсы:**

- В отличии от векторной картинки – можно делать с полученной моделью что угодно;
- Если не хватит сгенерированных элементов – можно добавить (например стикеры и комментарии);
- Если схема большая – можно двигать каждую связь или элемент, плюс выручает поиск по модели;

**Из минусов:**

- Могут теряться связи между элементами, особенно если связи указаны в коде, но не учтены в схеме бд. Пару раз попадался на эту уловку и приходилось руками достраивать модель, что малоприятно;
- Хоть с диаграммой можно делать что угодно, но первичная генерация хаотична. Поэтому для «наведения порядка» придется самостоятельно двигать элементы;
- Специфичный импорт, из-за чего придется под новую версию схемы делать новую диаграмму. А если добавили что-то кастомное, придется дублировать руками;
- Шарить модель может быть проблемно, особенно если используете lucid и душит жаба платить за кучу людей (но для конфлюенса был плагин);

Заметка: помните, что генераторы ERD присутствуют не везде. Например, [в miro нет ERD генераторов](https://miro.com/diagramming/er-diagram/), вместо этого, получите только элементы для того, чтобы самостоятельно рисовать модель. 

### Использование dbml

Персональное открытие прошлого года. Вместо рассказа, [лучше посмотреть самостоятельно](https://dbdiagram.io/d) (в верхнем левом углу, где лого, можно загрузить advanced sample, который использовался в примерах в начале статьи).

При этом, так как dbml схема типизирована, можно написать конвертер из erd в dbml и получить генерацию схемы из кода (делал так для [erd-rails](https://github.com/voormedia/rails-erd) генератора). После, вставляем схему в редактор и изучаем схему баз данных.

**Плюсы:**

- Из-за динамичности, можно двигать элементы, что работает с большими схемами;
- Diagram as a code. Можно [генерировать dbml схему по SQL](https://dbml.dbdiagram.io/cli#convert--a-sql-file-to-dbml), присутствует [библиотека для монги (не проверял)](https://github.com/stepanic/parse-server-SCHEMA-to-DBML), [для джанги](https://github.com/hamedsj/DbmlForDjango) библиотека существует;
- Предпросмотр работает в браузере, не надо ничего ставить локально;
- Так как генерация из кода – можно избежать ситуации, когда связи не отображаются, так как связей нет в схеме бд, но есть на уровне кода;
  
</br>

**Из минусов:**

- Нет нормальной экосистемы. Библиотеки придется писать самому, в частности для мало популярных языков;
- Еще один язык описания схемы, который придется изучить;
- Если хотите хранить и смотреть модели командой, придется платить. Хотите селфхостед – на 2023 год находил аналоги, но каждый оставлял желать лучшего;

### Генерация из редактора/IDE

Так как всю жизнь просидел в vim, без возможности выхода, то особо ничего сказать о генерации схем из редактора и инструментов для этого. Знаю, что инструменты существуют и пользователи jetbrains [могут смотреть на схему не выходя из редактора](https://www.jetbrains.com/help/datagrip/creating-diagrams.html#db_diagrams). Лучше погуглить самостоятельно.

## Итоги

Если необходимо смоделировать данные, то важно разобраться с целью модели, так как каждое представление закрывает определенные потребности:

- Концептуальная модель – говорит о том, какие данные используются системой и как данные связаны между собой. Подойдет если важно понять что за данные нужны в бизнес логике и как данные связаны между собой;
- Логическая модель – говорит о том, как данные структурируются в приложении. Поможет описать или посмотреть на схему бд. Можно сгенерировать автоматически;
- Физическая модель – говорит о том, как данные физически храниться будут. Сам не использовал, но допускаю, что поможет в инфраструктурных документах;

Если нужно визуализировать схему бд, то тут два варианта: для мелких схем или для примеров лучше взять генераторы или diagram as a code инструменты, а для больших схем лучше либо взять инструменты для диаграм, либо посмотреть в сторону dbml, который можно использовать и в качестве генератора.

## Что еще почитать по теме

Если тема data model заинтересовала, собрал четыре ссылки, по которым можно погрузиться в тему глубже. 

- [en] В статье не рассказывал про archimate. Хотя там так же [можно сделать нужную data model](https://eaprincipals.com/data-modeling-with-archi/). Если используете archi - ничего нового не узнаете, скорее всего;
- [en] [Статья из блога mongoDB, в которой рассказывается data modelling](https://www.mongodb.com/basics/data-modeling). В тексте найдете описание подхода, виды представлений, описание процесса, советы и еще больше инструментов и так далее;
- [en] [Статья о том, как сделать концептуальную модель](https://www.thoughtspot.com/data-trends/data-modeling/conceptual-data-model-examples), какие виды есть и в чем ее преимущества;
- [en] Серия статей о визуализации бд. По [ссылке третья часть](https://minimalmodeling.substack.com/p/visual-language-and-database-visualization), где упоминаются разные приложения для визуализации: MySQL Workbench,  Anchor,  TLDraw и Arrows.app;
